# Task 1:
SELECT orders.order_id, SUM(products.price*line_items.quantity) AS total_price 
FROM orders 
INNER JOIN line_items 
    ON line_items.order_id = orders.order_id 
INNER JOIN products 
    ON line_items.product_id = products.product_id 
GROUP BY orders.order_id 
ORDER BY orders.order_id
LIMIT 5;

# Task 2:
SELECT c.customer_name, AVG(t.total_price) AS average_order_price 
FROM customers c 
JOIN (
    SELECT orders.order_id, orders.customer_id, SUM(products.price*line_items.quantity) AS total_price 
    FROM orders 
    INNER JOIN line_items ON line_items.order_id = orders.order_id 
    INNER JOIN products ON products.product_id = line_items.product_id 
    GROUP BY orders.order_id
) AS t 
ON c.customer_id = t.customer_id 
GROUP BY c.customer_id, c.customer_name 
ORDER BY c.customer_name;

# Task 3:

## Get Perez&Sons customer_id: 16
SELECT customer_id, customer_name 
FROM customers 
WHERE customer_name LIKE 'Perez%';

## Get Miranda Harris emp_id: 7
SELECT (first_name||' '||last_name) as employee_name, employee_id 
FROM employees 
WHERE first_name='Miranda' AND last_name='Harris';

SELECT product_id, product_name, price 
FROM products 
ORDER BY price ASC 
LIMIT 5;

## Transaction!
BEGIN;

INSERT INTO orders(customer_id, employee_id, date)
VALUES (16, 7, '2025-12-20')
RETURNING order_id;

INSERT INTO line_items (order_id, product_id, quantity) 
SELECT $1, product_id, 1 
FROM products 
ORDER BY price ASC 
LIMIT 5;

COMMIT;

## See all items
SELECT * FROM line_items 
WHERE order_id = (SELECT order_id FROM orders ORDER BY order_id DESC LIMIT 1);

# Task 4:

SELECT first_name, last_name, COUNT(order_id) as order_count 
FROM orders 
INNER JOIN employees 
    ON employees.employee_id = orders.employee_id 
GROUP BY employees.employee_id, first_name, last_name 
HAVING COUNT(order_id) > 5 
ORDER BY last_name;